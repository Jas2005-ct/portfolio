<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Dashboard</title>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <style>
        :root {
            --primary-color: #00f2ea;
            --secondary-color: #ff0055;
            --accent-color: #7000ff;
            --text-color: #ffffff;
            --bg-gradient: linear-gradient(135deg, #050505 0%, #1a1a1a 100%);
            --sidebar-bg: #050505;
            --card-bg: rgba(20, 20, 20, 0.8);
        }

        body { 
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            min-height: 100vh;
            color: var(--text-color);
        }

        /* Sidebar */
        .sidebar { 
            height: 100vh; 
            background: var(--sidebar-bg); 
            color: #fff; 
            position: fixed; 
            width: 260px; 
            padding-top: 30px; 
            box-shadow: 4px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
            transition: all 0.3s ease;
            overflow-y: auto; /* Enable scrolling */
        }

        .sidebar h3 {
            font-weight: 700;
            letter-spacing: 1px;
            color: #fff;
            margin-bottom: 30px;
        }

        .sidebar .nav-link { 
            color: rgba(255,255,255,0.7); 
            text-decoration: none; 
            display: block; 
            padding: 12px 25px; 
            transition: all 0.3s;
            border-left: 4px solid transparent;
            font-weight: 500;
        }

        .sidebar .nav-link:hover, .sidebar .nav-link.active { 
            background: rgba(255,255,255,0.1); 
            color: #fff; 
            border-left-color: var(--accent-color);
        }

        .sidebar .nav-link i {
            width: 25px;
            text-align: center;
            margin-right: 10px;
        }

        /* Content Area */
        .content { 
            margin-left: 260px; 
            padding: 40px; 
            transition: all 0.3s ease;
        }

        h2 {
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 25px;
            position: relative;
            display: inline-block;
        }

        h2::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: -8px;
            width: 50px;
            height: 4px;
            background: var(--primary-color);
            border-radius: 2px;
        }

        /* Cards */
        .card { 
            border: none;
            border-radius: 15px;
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            margin-bottom: 25px; 
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
        }

        .form-label { 
            font-weight: 600; 
            color: #495057;
        }

        .form-control {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }

        .form-control:focus {
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.25);
            border-color: var(--primary-color);
        }

        .btn {
            border-radius: 8px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--secondary-color);
            border-color: var(--secondary-color);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #888; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555; 
        }
        
        /* Smooth Scrolling for whole page */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3 class="text-center">Dashboard</h3>
        <div class="text-center mb-4 text-muted">
            <small>Welcome, {{ user.profile.name }}</small>
        </div>
        <a href="#" class="nav-link active" data-target="profile"><i class="fas fa-user"></i> Profile</a>
        <a href="#" class="nav-link" data-target="education"><i class="fas fa-graduation-cap"></i> Education</a>
        <a href="#" class="nav-link" data-target="experience"><i class="fas fa-briefcase"></i> Experience</a>
        <a href="#" class="nav-link" data-target="skills"><i class="fas fa-code"></i> Skills</a>
        <a href="#" class="nav-link" data-target="tech-stack"><i class="fas fa-layer-group"></i> Tech Stack</a>
        <a href="#" class="nav-link" data-target="certificates"><i class="fas fa-certificate"></i> Certificates</a>
        <a href="#" class="nav-link" data-target="projects"><i class="fas fa-project-diagram"></i> Projects</a>
        <a href="#" class="nav-link" data-target="resume"><i class="fas fa-file-alt"></i> Resume</a>
        <a href="#" class="nav-link" data-target="social"><i class="fas fa-share-alt"></i> Social Links</a>
        <a href="{% url 'logout' %}" class="nav-link text-danger mt-4"><i class="fas fa-sign-out-alt"></i> Logout</a>
        <a href="/" class="nav-link mt-2 border-top pt-3"><i class="fas fa-home"></i> View Portfolio</a>
    </div>

    <div class="content">
        <div id="alert-container"></div>

        <!-- Profile Section -->
        <div id="profile-section" class="section">
            <h2>Profile Settings</h2>
            <div class="card p-4">
                <form id="profile-form">
                    <input type="hidden" name="id" id="profile-id">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Job Title</label>
                        <input type="text" class="form-control" name="title">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Bio</label>
                        <textarea class="form-control" name="bio" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone</label>
                        <input type="text" class="form-control" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" name="address"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Profile Image</label>
                        <input type="file" class="form-control" name="profile_image">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Profile</button>
                </form>
            </div>
        </div>

        <!-- Education Section -->
        <div id="education-section" class="section" style="display:none;">
            <h2>Education</h2>
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Education</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="education">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="course" placeholder="Course / Degree" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="institution" placeholder="Institution" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="text" class="form-control" name="course_duration" placeholder="Duration (e.g. 4 years)">
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="start_year" placeholder="Start Year" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="end_year" placeholder="End Year (leave empty if current)">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Education</button>
                </form>
            </div>
            <div id="education-list" class="row"></div>
        </div>

        <!-- Certificates Section -->
        <div id="certificates-section" class="section" style="display:none;">
            <h2>Certificates</h2>
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Certificate</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="certificates">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="course" placeholder="Course Name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="platform" placeholder="Platform (e.g. Coursera)" required>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label>Certificate Image</label>
                            <input type="file" class="form-control" name="image">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Certificate</button>
                </form>
            </div>
            <div id="certificates-list" class="row"></div>
        </div>

        <!-- Experience Section -->
        <div id="experience-section" class="section" style="display:none;">
            <h2>Experience (Jobs & Internships)</h2>
            
            <!-- Profession -->
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Job / Profession</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="professions">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="role" placeholder="Role / Job Title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="company" placeholder="Company" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="text" class="form-control" name="duration" placeholder="Duration">
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="start_year" placeholder="Start Year" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="end_year" placeholder="End Year">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Job</button>
                </form>
            </div>
            <div id="professions-list" class="row mb-5"></div>

            <!-- Internship -->
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Internship</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="internships">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="role" placeholder="Role" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="company" placeholder="Company" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="text" class="form-control" name="duration" placeholder="Duration">
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="start_year" placeholder="Start Year" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <input type="number" class="form-control" name="end_year" placeholder="End Year">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Internship</button>
                </form>
            </div>
            <div id="internships-list" class="row"></div>
        </div>

        <!-- Skills Section -->
        <div id="skills-section" class="section" style="display:none;">
            <h2>Skills</h2>
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Skill</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="skills">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="skill" placeholder="Skill Name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <select class="form-control" name="level">
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label>Skill Icon/Image</label>
                            <input type="file" class="form-control" name="image">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Skill</button>
                </form>
            </div>
            <div id="skills-list" class="row"></div>
        </div>

        <!-- Tech Stack Section -->
        <div id="tech-stack-section" class="section" style="display:none;">
            <h2>Tech Stack</h2>
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Select Tech Stack</h5>
                </div>
                <form id="tech-stack-form">
                    <input type="hidden" name="id" id="profile-tech-id">
                    <div class="mb-3">
                        <label class="form-label">Select Technologies</label>
                        <select class="form-control" name="technology_ids" id="tech-select" multiple style="height: 200px;">
                            <!-- Options injected here -->
                        </select>
                        <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple options.</small>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Tech Stack</button>
                </form>
            </div>
            <div id="selected-tech-list" class="row"></div>
        </div>

        <!-- Projects Section -->
        <div id="projects-section" class="section" style="display:none;">
            <h2>Projects</h2>
            <div class="card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5>Manage Project</h5>
                    <button type="button" class="btn btn-secondary btn-sm cancel-edit-btn" style="display:none;">Cancel Edit</button>
                </div>
                <form class="add-form" data-endpoint="projects">
                    <input type="hidden" name="id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="title" placeholder="Project Title" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Technologies</label>
                            <select class="form-control project-tech-select" name="technology_ids" multiple required>
                                <!-- Options loaded via JS -->
                            </select>
                        </div>
                        <div class="col-md-12 mb-3">
                            <textarea class="form-control" name="description" placeholder="Description" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="text" class="form-control" name="motive" placeholder="Motive" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <textarea class="form-control" name="problem_statement" placeholder="Problem Statement" required></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="url" class="form-control" name="github_link" placeholder="GitHub URL">
                        </div>
                        <div class="col-md-6 mb-3">
                            <input type="url" class="form-control" name="live_demo" placeholder="Live Demo URL">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label>Project Image</label>
                            <input type="file" class="form-control" name="image">
                            <small class="text-muted">Leave empty to keep current image</small>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success submit-btn">Add Project</button>
                </form>
            </div>
            <div id="projects-list" class="row"></div>
        </div>

        <!-- Resume Section -->
        <div id="resume-section" class="section" style="display:none;">
            <h2>Resume</h2>
            <div class="card p-4">
                <form id="resume-form">
                    <input type="hidden" name="id" id="resume-id">
                    <div class="mb-3">
                        <label class="form-label">Upload Resume (PDF)</label>
                        <input type="file" class="form-control" name="resume" accept=".pdf,.doc,.docx">
                    </div>
                    <div class="mb-3">
                        <p>Current Resume: <a href="#" id="current-resume-link" target="_blank" style="display:none;">View Resume</a></p>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Resume</button>
                </form>
            </div>
        </div>

        <!-- Social Section -->
        <div id="social-section" class="section" style="display:none;">
            <h2>Social Links</h2>
            <div class="card p-4">
                <form id="social-form">
                    <input type="hidden" name="id" id="social-id">
                    <div class="mb-3">
                        <label class="form-label">GitHub</label>
                        <input type="url" class="form-control" name="github">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">LinkedIn</label>
                        <input type="url" class="form-control" name="linkedin">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Twitter</label>
                        <input type="url" class="form-control" name="twitter">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Instagram</label>
                        <input type="url" class="form-control" name="instagram">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Facebook</label>
                        <input type="url" class="form-control" name="facebook">
                    </div>
                    <button type="submit" class="btn btn-primary">Save Links</button>
                </form>
            </div>
        </div>

    </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            // Navigation
            $('.nav-link').click(function(e) {
                if ($(this).data('target')) {
                    e.preventDefault();
                    $('.nav-link').removeClass('active');
                    $(this).addClass('active');
                    $('.section').hide();
                    $('#' + $(this).data('target') + '-section').fadeIn();
                }
            });

            // Helper: Get CSRF Token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            const csrftoken = getCookie('csrftoken');

            $.ajaxSetup({
                headers: { 'X-CSRFToken': csrftoken }
            });

            // Fetch Initial Data
            loadData();

            function loadData() {
                // Profile
                $.get('/api/profile/', function(data) {
                    if (data.length > 0) {
                        const profile = data[0];
                        $('#profile-id').val(profile.id);
                        $('input[name="name"]').val(profile.name);
                        $('input[name="title"]').val(profile.title);
                        $('textarea[name="bio"]').val(profile.bio);
                        $('input[name="phone"]').val(profile.phone);
                        $('textarea[name="address"]').val(profile.address);
                        
                        $('#profile-tech-id').val(profile.id);
                        
                        // Load Tech Stack Options
                        $.get('/api/technologies/', function(techs) {
                            let options = '';
                            techs.forEach(tech => {
                                let selected = profile.technologies && profile.technologies.some(t => t.id === tech.id) ? 'selected' : '';
                                options += `<option value="${tech.id}" ${selected}>${tech.name}</option>`;
                            });
                            $('#tech-select').html(options);
                            
                            // Initialize Select2 with Tagging
                            $('#tech-select').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Select or Type to Add Technologies',
                                allowClear: true,
                                width: '100%',
                                tags: true, // Allow creating new tags
                                createTag: function (params) {
                                    var term = $.trim(params.term);
                                    if (term === '') {
                                        return null;
                                    }
                                    return {
                                        id: term,
                                        text: term,
                                        newTag: true // add additional parameters
                                    }
                                }
                            });
                            
                            // Populate Project Tech Select as well
                            let projectOptions = '';
                            techs.forEach(tech => {
                                projectOptions += `<option value="${tech.id}">${tech.name}</option>`;
                            });
                            $('.project-tech-select').html(projectOptions);

                            // Initialize Select2 for Projects
                            $('.project-tech-select').select2({
                                theme: 'bootstrap-5',
                                placeholder: 'Select Technologies',
                                allowClear: true,
                                width: '100%',
                                dropdownParent: $('#projects-section') // Ensure it works inside the section
                            });

                            renderSelectedTechs(profile.technologies);
                        });
                    }
                });

                // Social
                $.get('/api/social-links/', function(data) {
                    if (data.length > 0) {
                        const social = data[0];
                        $('#social-id').val(social.id);
                        $('input[name="github"]').val(social.github);
                        $('input[name="linkedin"]').val(social.linkedin);
                        $('input[name="twitter"]').val(social.twitter);
                        $('input[name="instagram"]').val(social.instagram);
                        $('input[name="facebook"]').val(social.facebook);
                    }
                });

                // Resume
                $.get('/api/resume/', function(data) {
                    if (data.length > 0) {
                        const resume = data[0];
                        $('#resume-id').val(resume.id);
                        $('#current-resume-link').attr('href', resume.resume).show();
                    }
                });

                // Lists
                loadList('education', '#education-list');
                loadList('professions', '#professions-list');
                loadList('internships', '#internships-list');
                loadList('skills', '#skills-list');
                loadList('certificates', '#certificates-list');
                loadList('projects', '#projects-list');
            }

            function loadList(endpoint, containerId) {
                $.get('/api/' + endpoint + '/', function(data) {
                    let html = '';
                    data.forEach(item => {
                        let title = item.course || item.role || item.skill || item.title;
                        let subtitle = item.institution || item.company || item.level || item.tech_stack || '';
                        
                        html += `
                            <div class="col-md-6 mb-3">
                                <div class="card p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h5 class="mb-1">${title}</h5>
                                            <small class="text-muted">${subtitle}</small>
                                        </div>
                                        <div>
                                            <button class="btn btn-warning btn-sm edit-btn me-2" data-endpoint="${endpoint}" data-id="${item.id}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button class="btn btn-danger btn-sm delete-btn" data-endpoint="${endpoint}" data-id="${item.id}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    $(containerId).html(html);
                });
            }

            // Handle Profile, Social & Resume Forms (Single Instance)
            $('#profile-form, #social-form, #resume-form').submit(function(e) {
                e.preventDefault();
                let form = $(this);
                let id = form.find('input[name="id"]').val();
                let formData = new FormData(this);
                
                let url = id ? `/api/${form.attr('id').replace('-form', '')}/${id}/` : `/api/${form.attr('id').replace('-form', '')}/`;
                // Fix for social-links endpoint naming mismatch if needed, but standardizing is better.
                // The endpoint for social is 'social-links', but form id is 'social-form'.
                if (form.attr('id') === 'social-form') url = id ? `/api/social-links/${id}/` : `/api/social-links/`;
                if (form.attr('id') === 'resume-form') url = id ? `/api/resume/${id}/` : `/api/resume/`;
                if (form.attr('id') === 'profile-form') url = id ? `/api/profile/${id}/` : `/api/profile/`;
                let method = id ? 'PATCH' : 'POST';

                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function() {
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: 'Your changes have been saved successfully.',
                            timer: 2000,
                            showConfirmButton: false
                        });
                        loadData();
                    },
                    error: function(err) {
                        console.error(err);
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Something went wrong! Check console for details.'
                        });
                    }
                });
            });

            // Handle Tech Stack Form
            $('#tech-stack-form').submit(function(e) {
                e.preventDefault();
                let id = $('#profile-tech-id').val();
                let selectedValues = $('#tech-select').val(); // Array of IDs or Names (for new tags)
                
                if (!selectedValues) selectedValues = [];

                // Separate existing IDs from new Tag names
                let existingIds = [];
                let newTags = [];

                selectedValues.forEach(val => {
                    if (isNaN(val)) {
                        newTags.push(val);
                    } else {
                        existingIds.push(val);
                    }
                });

                // Function to create new technologies first
                let createPromises = newTags.map(tagName => {
                    return $.ajax({
                        url: '/api/technologies/',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ name: tagName })
                    });
                });

                // Wait for all new tags to be created
                Promise.all(createPromises)
                    .then(results => {
                        // Add the newly created IDs to the list
                        results.forEach(res => {
                            existingIds.push(res.id);
                        });

                        // Now update the profile with all IDs
                        return $.ajax({
                            url: `/api/profile/${id}/`,
                            type: 'PATCH',
                            contentType: 'application/json',
                            data: JSON.stringify({ technology_ids: existingIds })
                        });
                    })
                    .then(data => {
                        Swal.fire({
                            icon: 'success',
                            title: 'Saved!',
                            text: 'Tech stack updated successfully.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                        // Update UI
                        renderSelectedTechs(data.technologies);
                        
                        // Refresh options to include new tags properly
                        // (Optional: reload page or re-fetch options to ensure Select2 has correct IDs)
                    })
                    .catch(err => {
                        console.error(err);
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: 'Failed to update tech stack.'
                        });
                    });
            });

            function renderSelectedTechs(technologies) {
                let html = '';
                if (technologies && technologies.length > 0) {
                    technologies.forEach(tech => {
                        html += `
                            <div class="col-md-2 mb-3">
                                <div class="card p-2 text-center">
                                    <span class="badge bg-primary p-2 w-100">${tech.name}</span>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    html = '<p class="text-muted">No technologies selected.</p>';
                }
                $('#selected-tech-list').html(html);
            }

            // Handle Add/Edit Forms (Multiple Instances)
            $('.add-form').submit(function(e) {
                e.preventDefault();
                let form = $(this);
                let endpoint = form.data('endpoint');
                let formData = new FormData(this);
                let id = form.find('input[name="id"]').val();
                
                let url = id ? `/api/${endpoint}/${id}/` : `/api/${endpoint}/`;
                let method = id ? 'PATCH' : 'POST';

                $.ajax({
                    url: url,
                    type: method,
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function() {
                        form[0].reset();
                        form.find('input[name="id"]').val(''); // Clear ID
                        form.find('.project-tech-select').val(null).trigger('change'); // Reset Select2
                        form.find('.submit-btn').text('Add ' + endpoint.slice(0, -1).charAt(0).toUpperCase() + endpoint.slice(0, -1).slice(1)); // Reset button text
                        form.find('.submit-btn').removeClass('btn-warning').addClass('btn-success');
                        form.closest('.card').find('.cancel-edit-btn').hide(); // Hide cancel button
                        loadList(endpoint, '#' + endpoint + '-list');
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: 'Item saved successfully.',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    },
                    error: function(err) {
                        console.error(err);
                        let msg = 'Error saving item.';
                        if (err.responseJSON) {
                            msg = JSON.stringify(err.responseJSON);
                        }
                        Swal.fire({
                            icon: 'error',
                            title: 'Error',
                            text: msg
                        });
                    }
                });
            });

            // Handle Edit Click
            $(document).on('click', '.edit-btn', function() {
                let btn = $(this);
                let endpoint = btn.data('endpoint');
                let id = btn.data('id');
                
                // Fetch item details
                $.get(`/api/${endpoint}/${id}/`, function(data) {
                    // Find the form for this endpoint
                    let form = $(`.add-form[data-endpoint="${endpoint}"]`);
                    
                    // Populate fields
                    form.find('input[name="id"]').val(data.id);
                    $.each(data, function(key, value) {
                        let input = form.find(`[name="${key}"]`);
                        if (input.attr('type') !== 'file') {
                            if (key === 'technology_ids' && endpoint === 'projects') {
                                // Handle Select2 for Projects
                                // Assuming 'technologies' is returned with full objects, map to IDs
                                let selectedIds = data.technologies.map(t => t.id);
                                form.find('.project-tech-select').val(selectedIds).trigger('change');
                            } else {
                                input.val(value);
                            }
                        }
                    });

                    // Change UI to Edit Mode
                    form.find('.submit-btn').text('Update Item').removeClass('btn-success').addClass('btn-warning');
                    form.closest('.card').find('.cancel-edit-btn').show();
                    
                    // Scroll to form
                    $('html, body').animate({
                        scrollTop: form.offset().top - 100
                    }, 500);
                });
            });

            // Handle Cancel Edit
            $('.cancel-edit-btn').click(function() {
                let btn = $(this);
                let form = btn.closest('.card').find('form');
                let endpoint = form.data('endpoint');
                
                form[0].reset();
                form.find('input[name="id"]').val('');
                form.find('.project-tech-select').val(null).trigger('change'); // Reset Select2
                form.find('.submit-btn').text('Add ' + endpoint.slice(0, -1).charAt(0).toUpperCase() + endpoint.slice(0, -1).slice(1));
                form.find('.submit-btn').removeClass('btn-warning').addClass('btn-success');
                btn.hide();
            });

            // Handle Delete
            $(document).on('click', '.delete-btn', function() {
                let btn = $(this);
                let endpoint = btn.data('endpoint');
                let id = btn.data('id');

                Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $.ajax({
                            url: `/api/${endpoint}/${id}/`,
                            type: 'DELETE',
                            success: function() {
                                loadList(endpoint, '#' + endpoint + '-list');
                                Swal.fire(
                                    'Deleted!',
                                    'Your file has been deleted.',
                                    'success'
                                )
                            }
                        });
                    }
                })
            });

        });
    </script>
</body>
</html>
